/*!
 * remark (http://getbootstrapadmin.com/remark)
 * Copyright 2017 amazingsurge
 * Licensed under the Themeforest Standard Licenses
 */

define(["theme_remui/Chart","theme_remui/jquery-asPieProgress","theme_remui/aspieprogress","core/log"],function(Chart,pieprogress,PieProgress,log){function render_pie_chart(){null!==myDoughnut&&myDoughnut.destroy();var pieChartCanvas=jQuery("#pieChart").get(0).getContext("2d"),doughnutData={labels:resp.labels,datasets:[{data:resp.data,backgroundColor:resp.background_color,hoverBackgroundColor:resp.hoverBackground_color}]};myDoughnut=new Chart(pieChartCanvas,{type:"doughnut",data:doughnutData,options:pieOptions})}function createpiechart(){var category_id=jQuery("#coursecategorylist option:selected").data("id");jQuery.ajax({type:"GET",async:!0,url:M.cfg.wwwroot+"/theme/remui/request_handler.php?action=get_courses_by_category&categoryid="+category_id,success:function(response){if(null===(resp=JSON.parse(response)))jQuery("canvas#pieChart").hide(),jQuery(".enroll-stats-nouserserror").hide(),jQuery(".chart-legend").hide(),jQuery(".enroll-stats-error").show();else{jQuery(".enroll-stats-error").hide(),jQuery(".enroll-stats-nouserserror").hide(),jQuery(".chart-legend").show(),jQuery("canvas#pieChart").show(),jQuery("#enrolled_users_stats .chart-legend").empty();var colors=["#2196f3","#00bcd4","#009688","#4caf50","#8bc34a","#ffeb3b","#ff9800","#f44336","#9c27b0","#673ab7","#3f51b5"];jQuery.each(resp.labels,function(index,value){jQuery("#enrolled_users_stats .chart-legend").append('<li class="list-group-item p-0 pt-5">'+value+': <span class="badge badge-round" style="background-color:'+colors[index]+';">'+resp.data[index]+"</span></li>")}),render_pie_chart()}},error:function(xhr,status,error){jQuery("canvas#pieChart").hide(),jQuery(".enroll-stats-error").show()}})}function createBarChart(){var course_id=jQuery("#quiz-course-list option:selected").data("id");jQuery.ajax({type:"GET",async:!0,url:M.cfg.wwwroot+"/theme/remui/request_handler.php?action=get_courses_for_quiz&courseid="+course_id,success:function(response){if(void 0===(respBar=JSON.parse(response)).datasets)jQuery("div#quiz-chart-area").hide(),jQuery(".quiz-stats-error").show();else{null!==barChart&&barChart.destroy();var barcontext=jQuery("#barChart").get(0).getContext("2d");barcontext.canvas.height=400;var barData={labels:respBar.labels,datasets:respBar.datasets};barChart=new Chart(barcontext,{type:"bar",data:barData,options:{responsive:!0,maintainAspectRatio:!1}})}},error:function(xhr,status,error){jQuery("div#quiz-chart-area").hide(),jQuery(".quiz-stats-error").show()}})}function createAnalysisChart(){var course_id=jQuery("#quiz-overview #coursecategorylist option:selected").data("id");jQuery.ajax({type:"GET",async:!0,url:M.cfg.wwwroot+"/theme/remui/request_handler.php?action=ger_course_anlytics_ajax&courseid="+course_id,success:function(response){analysisBar=response,null!==analysisChart&&analysisChart.destroy(),response.error?(jQuery("#highestactivity").html(""),jQuery("#lowestactivity").html(""),jQuery("#highestgrade").html("0"),jQuery("#lowestgrade").html("0"),jQuery("#averagegrade").html("0")):(jQuery("#highestactivity").html(analysisBar.maxactivityname),jQuery("#lowestactivity").html(analysisBar.minactivityname),jQuery("#highestgrade").html(analysisBar.highest),jQuery("#lowestgrade").html(analysisBar.lowest),jQuery("#averagegrade").html(analysisBar.average));var context=jQuery("#analysisChart").get(0).getContext("2d");context.canvas.height=400;var analysisData={labels:analysisBar.labels,datasets:analysisBar.datasets};analysisChart=new Chart(context,{type:"bar",data:analysisData,options:{responsive:!0,maintainAspectRatio:!1,tooltips:{enabled:!0},hover:{animationDuration:0},layout:{padding:{top:20}},legend:{position:"bottom",labels:{padding:20,fontSize:12}},animation:{duration:1,onComplete:function(){var chartInstance=this.chart,ctx=chartInstance.ctx;ctx.font=Chart.helpers.fontString(Chart.defaults.global.defaultFontSize,Chart.defaults.global.defaultFontStyle,Chart.defaults.global.defaultFontFamily),ctx.textAlign="center",ctx.textBaseline="bottom",this.data.datasets.forEach(function(dataset,i){var meta=chartInstance.controller.getDatasetMeta(i);1!=meta.hidden&&meta.data.forEach(function(bar,index){var data=dataset.data[index];ctx.fillText(data,bar._model.x,bar._model.y-5)})})}},scales:{xAxes:[{display:!1,gridLines:{display:!0}}],yAxes:[{ticks:{beginAtZero:!0},gridLines:{display:!0}}]}}})},error:function(xhr,status,error){jQuery("div#analysis-chart-area").hide()}})}jQuery(".remui-course-progress").asPieProgress({namespace:"pie-progress",speed:30,classes:{svg:"pie-progress-svg",element:"pie-progress",number:"pie-progress-number",content:"pie-progress-content"}});var resp,myDoughnut=null,barChart=null,analysisChart=null,pieOptions={segmentShowStroke:!0,segmentStrokeColor:"#fff",segmentStrokeWidth:1,percentageInnerCutout:50,animationSteps:100,animateRotate:!0,animateScale:!1,responsive:!0,maintainAspectRatio:!0,legendTemplate:'<ul class="<%=name.toLowerCase()%>-legend"><% for (var i=0; i<segments.length; i++){%><span style="background-color:<%=segments[i].fillColor%>"></span><%if(segments[i].label){%><%=segments[i].label%><%}%></li><%}%></ul>',tooltipTemplate:"<%=value %> <%=label%> users",legend:{display:!1}};jQuery("#enrolled_users_stats select").length&&(jQuery("#enrolled_users_stats select#coursecategorylist").on("change",function(){createpiechart()}),createpiechart());var respBar;jQuery("#barChart").length&&(jQuery("#quiz_stats select#quiz-course-list").on("change",function(){createBarChart()}),createBarChart());var analysisBar;if(jQuery("#analysisChart").length&&(jQuery("#quiz-overview #coursecategorylist").on("change",function(){createAnalysisChart()}),createAnalysisChart()),jQuery(".add-notes-select").length){jQuery(".add-notes-button a").hide(),jQuery(".select2-studentlist").hide();var course_id,student_count,user_id,course_name;jQuery(".add-notes-select select").on("change",function(){if(jQuery(".add-notes-button a").hide(),course_id=jQuery(this).children(":selected").attr("id"),course_name=jQuery(this).children(":selected").text(),void 0===course_id)return jQuery(".select2-studentlist").empty(),void jQuery(".select2-studentlist").hide();jQuery.ajax({type:"GET",async:!0,url:M.cfg.wwwroot+"/theme/remui/request_handler.php?action=get_userlist&courseid="+course_id,success:function(data){student=JSON.parse(data),student_count=Object.keys(student).length,jQuery(".select2-studentlist").show(),jQuery(".select2-studentlist").empty(),student_count?jQuery(".select2-studentlist").append("<option>"+M.util.get_string("selectastudent","theme_remui")+" ("+M.util.get_string("total","theme_remui")+": "+student_count+")</option>"):jQuery(".select2-studentlist").append("<option>"+M.util.get_string("nousersenrolledincourse","theme_remui",course_name)+"</option>"),jQuery.each(student,function(index,value){jQuery(".select2-studentlist").append('<option value="'+index+'">'+value.firstname+" "+value.lastname+"</option>")}),data=""},error:function(xhr,status,error){jQuery(".select2-studentlist").html("<option>"+error+"</option>")}})}),jQuery(".select2-studentlist").on("change",function(){jQuery(".add-notes-button a").show(),user_id=jQuery(this).find("option:selected").val();var notes_link=M.cfg.wwwroot+"/notes/edit.php?courseid="+course_id+"&userid="+user_id+"&publishstate=site";jQuery(".add-notes-button .site-note").attr("href",notes_link),notes_link=M.cfg.wwwroot+"/notes/edit.php?courseid="+course_id+"&userid="+user_id+"&publishstate=public",jQuery(".add-notes-button .course-note").attr("href",notes_link),notes_link=M.cfg.wwwroot+"/notes/edit.php?courseid="+course_id+"&userid="+user_id+"&publishstate=draft",jQuery(".add-notes-button .personal-note").attr("href",notes_link)})}jQuery("div.block-myoverview a.panel-title").click(function(){jQuery(this).find("i").toggleClass("fa-angle-up")})});