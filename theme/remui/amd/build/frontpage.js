define(["jquery","core/modal_factory","core/templates","core/str","core/modal_events","theme_remui/sectionmanager","core/fragment","core/ajax","core/notification","theme_remui/events","theme_remui/html2canvas"],function(h,n,s,i,a,e,o,r,c,t,u){var l=-1,d=null,m=null,f=".add-section",g=".editing-action",p=".publish",v=".settings",y=".home-sections button.section-visibility",_=e.init();function b(e,t){var i={dots:!1,arrows:!0,infinite:!1,speed:500,prevArrow:h("section[data-instance='"+e+"'] .button-container .btn-prev"),nextArrow:h("section[data-instance='"+e+"'] .button-container .btn-next"),rtl:"rtl"==h("html").attr("dir"),slidesToShow:4,slidesToScroll:4,responsive:[{breakpoint:1024,settings:{slidesToShow:3,slidesToScroll:3}},{breakpoint:800,settings:{slidesToShow:2,slidesToScroll:2}},{breakpoint:480,settings:{slidesToShow:1,slidesToScroll:1}}]};Object.assign(i,t);var n=_.getSectionElement(e);n.find(".available-courses").addClass("d-none"),0==n.find(".courses-slider .empty-courses-container").length&&(n.find(".courses-slider").slick(i).on("setPosition",function(e,t){h(n).find(".slick-slide > div").css("height","100%"),t.$slides.css("height",t.$slideTrack.height()+"px")}),n.find(".available-courses").removeClass("d-none"))}function w(i,e,n){_.showSectionLoader(i,!0);var o=_.getSectionElement(i);o.find(".courses-slider").removeClass("show"),r.call([{methodname:"theme_remui_get_frontpage_section_courses_in_category",args:{instanceid:i,categoryid:e},done:function(e){e=JSON.parse(e);o.find(".courses-slider.slick-initialized.slick-slider").slick("unslick"),o.find(".courses-slider").empty(),s.render("theme_remui/hs_courses_cards",e).done(function(e,t){s.appendNodeContents(o.find(".courses-slider"),e,t),b(i,{slidesToShow:3,slidesToScroll:3}),"function"==typeof n&&n()}).fail(c.exception),_.showSectionLoader(i,!1)},fail:function(e){_.showSectionLoader(i,!1),c.exception(e)}}])}h(document).ready(function(){h(".flash").hide();h("#take_screenshot").click(function(e){e.preventDefault(),h(".flash").show().animate({opacity:.4},300).fadeOut(300).css({opacity:1}),h("#take_screenshot").html('<i class="fa fa-spinner fa-spin" aria-hidden="true"></i>'),d(),1==appearanimation&&""!=appearanimationstyle&&h(".home-sections section.panel, .default-sections.panel").removeClass(appearanimationstyle).removeClass("animation-slide-left").removeClass("animation-slide-right");for(var t,i,n=document.getElementById("videofixCanvas"),o=n.getContext("2d"),s=document.querySelectorAll("video"),a=0,r=s.length;a<r;a++){var c=s[a];try{t=c.videoWidth,i=c.videoHeight,n.width=t,n.height=i,o.fillRect(0,0,t,i),o.drawImage(c,0,0,t,i),c.style.backgroundImage="url('"+n.toDataURL()+"')",c.style.backgroundSize="cover",o.clearRect(0,0,0,0)}catch(e){continue}}setTimeout(l,2e3)});var e={logging:!1,useCORS:!0};function l(){u(document.querySelector(".page"),e).then(function(e){var t=e.toDataURL("image/jpeg",.95),i=new FormData;i.append("base64",t);var n=M.cfg.wwwroot.replace(/(^\w+:|^)\/\//,"");n=String(n).replace("#",""),n=String(n).replace("/",""),n=String(n).replace(".","-"),i.append("hash",n+"-"+Math.random().toString(36).substring(7)),h.ajax({url:"https://share.edwiser.org/api/base64.php",type:"POST",crossDomain:!0,data:i,async:!0,cache:!1,contentType:!1,processData:!1,success:function(e){parsed=JSON.parse(e),"ok"==parsed.status?(h("section.take-screenshot").hide(),h("#take_screenshot").html("CAPTURE AGAIN"),h(".screenshot-container .screenshot").css("background","url("+parsed.url+")"),h(".delete-screenshot").attr("data-deleteurl",parsed.delete_url),h(".download-screenshot").attr("href",parsed.url),h(".preview-screenshot").attr("href",parsed.url),h("section.taken-screenshot").show(),h("a.social-facebook").attr("href","https://www.facebook.com/sharer/sharer.php?u="+parsed.url),h("a.social-twitter").attr("href","https://twitter.com/share?url="+parsed.url),h("a.social-linkedin").attr("href","https://www.linkedin.com/shareArticle?mini=true&url="+parsed.url)):(h(".failed-screenshot-message").html("Something went wrong!"),h("#take_screenshot").html("Capture Again"))},error:function(e,t,i){h(".failed-screenshot-message").html(i),h("#take_screenshot").html("CAPTURE AGAIN")}})})}function d(){h(".failed-screenshot-message").html(""),h(".screenshot-container .screenshot").css("background",""),h(".delete-screenshot").attr("data-deleteurl",""),h(".download-screenshot").attr("href",""),h(".preview-screenshot").attr("href",""),h("a.social-facebook").attr("href",""),h("a.social-linkedin").attr("href",""),h("a.social-twitter").attr("href","")}h(".delete-screenshot").click(function(e){var t=h(".delete-screenshot").data("deleteurl");d(),h("section.taken-screenshot").hide(),h("section.take-screenshot").show(),t&&h.ajax({url:t,type:"GET",dataType:"json",crossDomain:!0,async:!0})}),h("#screenshotShareModal").on("hidden.bs.modal",function(e){d(),h("section.taken-screenshot").hide(),h("section.take-screenshot").show()}),h("a.social-share ").click(function(e){e.preventDefault();var t,i=h(this),n=i.attr("href"),o=i.attr("data-network"),s={facebook:{width:600,height:300},twitter:{width:600,height:254},linkedin:{width:600,height:473}};t=o,window.open(n,"","menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height="+s[t].height+",width="+s[t].width)}),h(window).scroll(function(){if(h(".pagelayout-frontpage section.lazy-section").each(function(e){if(h(this).position().top<h(window).scrollTop()+h(window).height()+2*h(window).height()&&h(this).is(".lazy-section")){h(this).removeClass("lazy-section");var t=h(this).data("instance"),i=_.getLoadedSection(t);_.reloadSection({success:!0,context:i},function(){h('.home-sections section[data-instance="'+t+'"]')})}else;}),h(".pagelayout-frontpage section.invisible").each(function(e){h(this).position().top+100<h(window).scrollTop()+h(window).height()&&setTimeout(function(){h(this).removeClass("invisible"),1==appearanimation&&("animation-slide-left-right"==appearanimationstyle?h(this).prev().is(".animation-slide-left")?h(this).addClass("animation-slide-right"):h(this).addClass("animation-slide-left"):h(this).addClass(appearanimationstyle))}.bind(this),100)}),transparentheader){if(h("section[data-instance]:first-child").is(".section-slider"))if(h(window).scrollTop()<10)return void h("body.has-slider").addClass("animate-header");h("body.has-slider").removeClass("animate-header")}}),"undefined"!=typeof createfrontpagesections&&1==createfrontpagesections&&n.create({type:n.types.SAVE_CANCEL,title:M.util.get_string("migratorheader","theme_remui"),body:M.util.get_string("migratormessge","theme_remui")},h("#create")).done(function(e){e.show(),e.setSaveButtonText(M.util.get_string("migrate","theme_remui")),e.getRoot().on(a.save,function(e){e.preventDefault(),window.location.href=M.cfg.wwwroot+"/?redirect=0&migrate=1"}),e.getRoot().on(a.hidden,function(){window.location.href=M.cfg.wwwroot+"/?redirect=0&nomigrate=1",e.destroy()})})}),h(document).on("slid.bs.carousel",".home-sections section .carousel",function(){var e=h(this).parent().data("instance");_.playSliderVideo(e)}),h(document).on("click",g,function(){var e=h('<form method="post"></form>');e.append("<input type='hidden' name='frontpageediting' value='1'/>"),e.append("<input type='hidden' name='editpage' value='"+h(this).data("edit")+"'/>"),h("body").append(e),e.submit()}),h(document).on("click",p,function(){var e=h('<form method="post"></form>');e.append("<input type='hidden' name='frontpageediting' value='1'/>"),e.append("<input type='hidden' name='publish' value='1'/>"),h("body").append(e),e.submit()}),h(document).on("click",".preview-section",function(){_.showAllSectionsLoader(),h(this).find("i").toggleClass("fa-eye fa-eye-slash");var e=h(this).find("i").is(".fa-eye-slash");if(h("body").toggleClass("preview",e),h(v+","+p+","+f+","+g+",.editing-alert").toggleClass("d-flex",!e).toggleClass("d-none",e),h("html, body").animate({scrollTop:0},h(window).scrollTop()/6),h(y+" .fa-eye-slash").parents("section[data-instance]").toggleClass("section-invisible",e),transparentheader)if(e){var t=h("body").find("section[data-instance]:not(.section-invisible)"),i=!1;t&&(i=h(t[0]).is(".section-slider")),h("body").toggleClass("has-slider animate-header",i)}else h("body").toggleClass("has-slider animate-header",h("body").find("section[data-instance]:first-child").is(".section-slider"));setTimeout(function(){_.hideAllSectionsLoader()},2e3)}),h(document).on(t.SECTION_ADDED+" "+t.SECTION_UPDATED,function(e){switch(e.configdata.sectionname){case"courses":var t=_.getSectionElement(e.configdata.id);if(t.is(".categoryandcourses-view")&&0!=e.configdata.catlist.length){var i=e.configdata.catlist[0].categoryid;w(e.configdata.id,i)}else b(t.data("instance"))}}),h("body").on("click",".home-sections .section-courses .category-list .category-item",function(){var e=h(this).parents("section[data-instance]").data("instance");h(this).parents("section[data-instance]").find(".courses-slider").removeClass("show"),w(e,h(this).data("id"),function(){h(this).siblings().removeClass("active"),h(this).addClass("active"),h(this).parents(".category-list").removeClass("show")}.bind(this))}),h("body").on("click",".home-sections .section-courses .category-list .site-skintools-toggle",function(){h(this).parents(".category-list").toggleClass("show")}),h(document).on("click",v,function(){n.create({type:n.types.SAVE_CANCEL,title:M.util.get_string("homepagesettings","theme_remui"),body:o.loadFragment("theme_remui","frontpage_settings_form",l)},h("#create")).done(function(n){n.modal.addClass("modal-sidebar d-inline-flex editmodal"),n.show(),n.getRoot().on(a.save,function(e){e.preventDefault();var t=n.getRoot().find("form"),i=JSON.stringify(t.serialize());r.call([{methodname:"theme_remui_save_frontpage_settings",args:{settings:i}}])[0].done(function(e){window.location.reload()}).fail(c.exception),n.hide()}),n.getRoot().on(a.hidden,function(){n.destroy()})})}),h(document).on("click",".sections-container div[class*='section-']",function(){var e=h(this).data("section");d.hide(),_.setSectionName(e),_.addSection()}),h("body").on("click",".moveup-section",function(){_.reorderSection(h(this).data("instance"),-1)}).on("click",".movedown-section",function(){_.reorderSection(h(this).data("instance"),1)}),h("body").on("click",y,function(){var e=h(this).data("instance"),t=h(this).data("visible");_.updateVisibility(e,!t)});function k(e){var t=h(e).attr("id").replace("id_block_","").replace("_style",""),i="#id_block_"+t+"_htmleditable ",n=h(e).val().replace(/(([\.\#]?[\w\d\_\-]+\s*)+\{)/,function(e){return i+e});h(e).next().is("#block-"+t+"-style")||h(e).after('<style id="block-'+t+'-style" type="text/css"></style>'),h(e).next().html(n)}h("body").on("input",".block-style textarea",function(){k(h(this))});function S(e){return h(e).attr("data-instance")}h("body").on("input",".separator-style select, .separator-style input",function(){!function(e){var t=h(e).find("#id_style").val(),i=h(e).find('[name="color"]').val(),n=h(e).find('[name="color2"]').val(),o=h(e).find("#id_height").val(),s={margin:"0px auto",width:h(e).find("#id_width").val()+"%"};switch(h(e).find('[name="color2"]').parents(".separator-style").toggleClass("d-none","gradient"!=t),t){case"blur":s.height="0px",s["background-image"]="none",s.border="1px solid "+i,s["box-shadow"]="0 0 "+o+"px "+o/2+"px "+i;break;case"blurend":s.background="none",s["box-shadow"]="none",s.border="none",s.height=o+"px",s["background-image"]="linear-gradient(to right, #ffffff, "+i+", #ffffff)";break;case"gradient":s["box-shadow"]="none",s["background-image"]="none",s.border="none",s.height=o+"px",s.background="linear-gradient(to right, "+i+" 0%, "+n+" 50%, "+i+" 100%)";break;default:s["box-shadow"]="none",s["background-image"]="none",s.height="0px",s["border-top"]=o+"px "+t+" "+i}h(e).find("#remui_separator_output").css(s)}(h(this).closest("form"))}),h("body").on("change",".updateform select",function(){var e=h(this).parents("form").find('[name="instanceid"]').val(),t=JSON.stringify(m.getRoot().find("form").serialize()),i=x(e,t);m.setBody(i)}),h(document).on("click",".home-sections button.edit-section",function(){var o=S(this),e=function(e){return h(e).attr("data-sectionname")}(this);n.create({type:n.types.SAVE_CANCEL,title:"Edit "+e.charAt(0).toUpperCase()+e.slice(1)+" Section",body:x(o,null)}).then(function(e){(m=e).modal.addClass("modal-sidebar d-inline-flex editmodal");var n=e.getRoot();n.on(a.save,function(e){e.preventDefault();var t=n.find("form");if("undefined"==typeof remui_section_form_validate||remui_section_form_validate(t)){var i=JSON.stringify(t.serialize());_.updateSection(o,i),m.hide()}}),n.on(a.hidden,function(){m.destroy(),h(document).find(".mform.atto_form.atto_media").parents(".moodle-dialogue-base").remove()}),e.show()})}),h(document).on("click",".home-sections button.delete-section",function(){var i=S(this);n.create({type:n.types.SAVE_CANCEL,title:"Delete item",body:"Do you really want to delete?"}).then(function(e){e.setSaveButtonText("Delete");var t=e.getRoot();t.on(a.save,function(){_.deleteInstance(i)}),t.on(a.hidden,function(){e.destroy()}),e.show()})}),h(document).on("click",".home-sections button.cancel-delete-section",function(){var e=S(this);_.deleteInstance(e,!1)}),h(document).on("click",".home-sections button.confirm-delete-section",function(){var e=S(this);_.deleteInstance(e,2)});function C(){!function(e){var t=h(f);h.when(i.get_strings([{key:"addsection",component:"theme_remui"}]),n.create({large:!0,body:s.render("theme_remui/hs_sections_list",e)},t)).then(function(e,t){(d=t).setTitle(e[0]),t.modal.addClass("modal-sidebar d-inline-flex w-500 ")}.bind(this)).fail(c.exception)}({sections:[{section:"slider",title:M.util.get_string("slidersection","theme_remui"),imageurl:M.util.image_url("imgs/screenshots/slider","theme_remui")},{section:"aboutus",title:M.util.get_string("aboutussection","theme_remui"),imageurl:M.util.image_url("imgs/screenshots/aboutus","theme_remui")},{section:"contact",title:M.util.get_string("contactsection","theme_remui"),imageurl:M.util.image_url("imgs/screenshots/contact","theme_remui")},{section:"feature",title:M.util.get_string("featuresection","theme_remui"),imageurl:M.util.image_url("imgs/screenshots/feature","theme_remui")},{section:"courses",title:M.util.get_string("coursessection","theme_remui"),imageurl:M.util.image_url("imgs/screenshots/courses","theme_remui")},{section:"team",title:M.util.get_string("teamsection","theme_remui"),imageurl:M.util.image_url("imgs/screenshots/team","theme_remui")},{section:"testimonial",title:M.util.get_string("testimonialsection","theme_remui"),imageurl:M.util.image_url("imgs/screenshots/testimonial","theme_remui")},{section:"html",title:M.util.get_string("htmlsection","theme_remui"),imageurl:M.util.image_url("imgs/screenshots/html","theme_remui")},{section:"separator",title:M.util.get_string("separatorsection","theme_remui"),imageurl:M.util.image_url("imgs/screenshots/separator","theme_remui")}]})}var x=function(e,t){var i={instanceid:e};null!=t&&(i.formdata=t);var n=o.loadFragment("theme_remui","frontpage_section_form",l,i);return n.done(function(e,t){setTimeout(function(){var e=h("body").find("form .block-style textarea");0!=e.length&&e.each(function(e,t){k(h(t))})},2e3)}),n};return{init:function(e,t){t&&C(),l=e,_.LoadAllSections()}}});